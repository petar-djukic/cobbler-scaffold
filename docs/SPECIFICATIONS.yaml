# Copyright (c) 2026 Petar Djukic. All rights reserved.
# SPDX-License-Identifier: MIT

id: specifications-cobbler-scaffold
title: Cobbler Scaffold Specifications

overview: |
  We build a Go library that automates AI-driven code generation through a
  two-phase cobbler workflow: measure proposes tasks, stitch executes them in
  isolated git worktrees. This document indexes every PRD, use case, and test
  suite in the project and shows how they trace to each other. For goals and
  boundaries see VISION.yaml. For components and interfaces see ARCHITECTURE.yaml.

roadmap_summary:
  - version: "01.0"
    name: Core Orchestrator and Workflows
    use_cases_done: 9
    use_cases_total: 9
    status: done

  - version: "02.0"
    name: VS Code Extension
    use_cases_done: 6
    use_cases_total: 6
    status: done

  - version: "99.0"
    name: Unscheduled
    use_cases_done: 0
    use_cases_total: 0
    status: not started

prd_index:
  - id: prd001-orchestrator-core
    title: Orchestrator Core Interface
    summary: Defines the Config struct, constructor, defaults, YAML loading, and initialization for consuming projects
    path: specs/product-requirements/prd001-orchestrator-core.yaml

  - id: prd002-generation-lifecycle
    title: Generation Lifecycle Management
    summary: Defines generation branch naming, start, run, resume, stop, reset, list, and switch operations
    path: specs/product-requirements/prd002-generation-lifecycle.yaml

  - id: prd003-cobbler-workflows
    title: Cobbler Measure and Stitch Workflows
    summary: Defines the measure and stitch phases, prompt templates, Claude invocation, recovery, and phase-specific context files
    path: specs/product-requirements/prd003-cobbler-workflows.yaml

  - id: prd005-metrics-collection
    title: Metrics Collection and Reporting
    summary: Defines InvocationRecord, LOC snapshots, stats collection, and token parsing
    path: specs/product-requirements/prd005-metrics-collection.yaml

  - id: prd006-vscode-extension
    title: VS Code Extension
    summary: Defines lifecycle commands, generation browser, branch comparison, issue tracker, metrics dashboard, specification browser, and code-to-spec traceability
    path: specs/product-requirements/prd006-vscode-extension.yaml

use_case_index:
  - id: rel01.0-uc001-orchestrator-initialization
    title: Orchestrator Initialization and Configuration
    release: "01.0"
    status: done
    path: specs/use-cases/rel01.0-uc001-orchestrator-initialization.yaml

  - id: rel01.0-uc002-generation-lifecycle
    title: Generation Lifecycle from Start to Stop
    release: "01.0"
    status: done
    path: specs/use-cases/rel01.0-uc002-generation-lifecycle.yaml

  - id: rel01.0-uc003-measure-workflow
    title: Measure Workflow Task Proposal
    release: "01.0"
    status: done
    path: specs/use-cases/rel01.0-uc003-measure-workflow.yaml

  - id: rel01.0-uc004-stitch-workflow
    title: Stitch Workflow Task Execution
    release: "01.0"
    status: done
    path: specs/use-cases/rel01.0-uc004-stitch-workflow.yaml

  - id: rel01.0-uc005-resume-recovery
    title: Generation Resume and Task Recovery
    release: "01.0"
    status: done
    path: specs/use-cases/rel01.0-uc005-resume-recovery.yaml

  - id: rel01.0-uc006-scaffold-operations
    title: Scaffold Operations
    release: "01.0"
    status: done
    path: specs/test-suites/test-rel01.0.yaml

  - id: rel01.0-uc007-build-tooling
    title: Build Tooling
    release: "01.0"
    status: done
    path: specs/test-suites/test-rel01.0.yaml

  - id: rel01.0-uc008-performance-benchmarks
    title: Performance Benchmarks
    release: "01.0"
    status: done
    path: specs/use-cases/rel01.0-uc008-performance-benchmarks.yaml

  - id: rel01.0-uc009-phase-context-files
    title: Phase-Specific Context File Loading
    release: "01.0"
    status: done
    path: specs/use-cases/rel01.0-uc009-phase-context-files.yaml

  - id: rel02.0-uc001-lifecycle-commands
    title: VS Code Lifecycle Commands
    release: "02.0"
    status: done
    path: specs/use-cases/rel02.0-uc001-lifecycle-commands.yaml

  - id: rel02.0-uc002-generation-browser
    title: Generation Browser Tree View
    release: "02.0"
    status: done
    path: specs/use-cases/rel02.0-uc002-generation-browser.yaml

  - id: rel02.0-uc003-branch-comparison
    title: Branch and Tag Comparison
    release: "02.0"
    status: done
    path: specs/use-cases/rel02.0-uc003-branch-comparison.yaml

  - id: rel02.0-uc004-issue-tracker-view
    title: Issue Tracker View
    release: "02.0"
    status: done
    path: specs/use-cases/rel02.0-uc004-issue-tracker-view.yaml

  - id: rel02.0-uc005-metrics-dashboard
    title: Metrics Dashboard Webview
    release: "02.0"
    status: done
    path: specs/use-cases/rel02.0-uc005-metrics-dashboard.yaml

  - id: rel02.0-uc006-specification-browser
    title: Specification Browser and Code-to-Spec Traceability
    release: "02.0"
    status: done
    path: specs/use-cases/rel02.0-uc006-specification-browser.yaml

test_suite_index:
  - id: test-rel01.0
    title: Release 01.0 test suite
    release: rel01.0
    traces:
      - rel01.0-uc001-orchestrator-initialization
      - rel01.0-uc002-generation-lifecycle
      - rel01.0-uc003-measure-workflow
      - rel01.0-uc004-stitch-workflow
      - rel01.0-uc005-resume-recovery
      - rel01.0-uc006-scaffold-operations
      - rel01.0-uc007-build-tooling
      - rel01.0-uc008-performance-benchmarks
      - rel01.0-uc009-phase-context-files
    test_case_count: 75
    path: specs/test-suites/test-rel01.0.yaml

  - id: test-rel02.0
    title: Release 02.0 test suite
    release: rel02.0
    traces:
      - rel02.0-uc001-lifecycle-commands
      - rel02.0-uc002-generation-browser
      - rel02.0-uc003-branch-comparison
      - rel02.0-uc004-issue-tracker-view
      - rel02.0-uc005-metrics-dashboard
      - rel02.0-uc006-specification-browser
    test_case_count: 30
    path: specs/test-suites/test-rel02.0.yaml

prd_to_use_case_mapping:
  - use_case: rel01.0-uc001-orchestrator-initialization
    prd: prd001-orchestrator-core
    why_required: Validates Config struct, constructor defaults, and Init method
    coverage: R1, R2, R5

  - use_case: rel01.0-uc002-generation-lifecycle
    prd: prd002-generation-lifecycle
    why_required: Exercises generation start, run, stop, and list operations
    coverage: R2, R3, R5, R7

  - use_case: rel01.0-uc003-measure-workflow
    prd: prd001-orchestrator-core
    why_required: Uses Config workflow fields for measure configuration
    coverage: R1 (partial)

  - use_case: rel01.0-uc003-measure-workflow
    prd: prd003-cobbler-workflows
    why_required: Validates measure phase - prompt rendering, Claude invocation, issue import
    coverage: R1, R2, R5, R6, R7

  - use_case: rel01.0-uc003-measure-workflow
    prd: prd005-metrics-collection
    why_required: Records InvocationRecord on each created issue
    coverage: R1 (partial)

  - use_case: rel01.0-uc004-stitch-workflow
    prd: prd001-orchestrator-core
    why_required: Uses Config workflow fields for stitch configuration
    coverage: R1 (partial)

  - use_case: rel01.0-uc004-stitch-workflow
    prd: prd003-cobbler-workflows
    why_required: Validates stitch phase - worktree isolation, Claude execution, merge, close
    coverage: R1, R3, R4, R6

  - use_case: rel01.0-uc004-stitch-workflow
    prd: prd005-metrics-collection
    why_required: Records InvocationRecord with LOC snapshots and diff stats
    coverage: R1, R2, R5

  - use_case: rel01.0-uc005-resume-recovery
    prd: prd002-generation-lifecycle
    why_required: Exercises resume and branch resolution logic
    coverage: R4, R9

  - use_case: rel01.0-uc005-resume-recovery
    prd: prd003-cobbler-workflows
    why_required: Exercises stale task recovery and orphaned issue reset
    coverage: R4

  - use_case: rel01.0-uc009-phase-context-files
    prd: prd003-cobbler-workflows
    why_required: Validates PhaseContext loading, override logic, and fallback behavior
    coverage: R9

  - use_case: rel02.0-uc001-lifecycle-commands
    prd: prd006-vscode-extension
    why_required: Validates lifecycle command registration, terminal execution, and confirmation dialogs
    coverage: R1

  - use_case: rel02.0-uc002-generation-browser
    prd: prd006-vscode-extension
    why_required: Validates generation tree discovery from git tags with lifecycle state
    coverage: R2

  - use_case: rel02.0-uc003-branch-comparison
    prd: prd006-vscode-extension
    why_required: Validates tag-to-tag and generation-to-generation diff views
    coverage: R3

  - use_case: rel02.0-uc004-issue-tracker-view
    prd: prd006-vscode-extension
    why_required: Validates issue tree parsing, status grouping, and InvocationRecord display
    coverage: R4

  - use_case: rel02.0-uc005-metrics-dashboard
    prd: prd006-vscode-extension
    why_required: Validates metrics aggregation, dashboard rendering, and data refresh
    coverage: R5

  - use_case: rel02.0-uc006-specification-browser
    prd: prd006-vscode-extension
    why_required: Validates spec tree navigation, touchpoint expansion, and CodeLens traceability
    coverage: R8, R9

traceability_diagram: |
  graph LR
      subgraph PRDs
          prd1["prd001\norchestrator-core"]
          prd2["prd002\ngeneration-lifecycle"]
          prd3["prd003\ncobbler-workflows"]
          prd5["prd005\nmetrics-collection"]
          prd6["prd006\nvscode-extension"]
      end

      subgraph UseCases01["Release 01.0 Use Cases"]
          uc1["uc001\ninitialization"]
          uc2["uc002\ngeneration-lifecycle"]
          uc3["uc003\nmeasure-workflow"]
          uc4["uc004\nstitch-workflow"]
          uc5["uc005\nresume-recovery"]
          uc8["uc008\nbenchmarks"]
          uc9["uc009\nphase-context"]
      end

      subgraph UseCases02["Release 02.0 Use Cases"]
          vuc1["uc001\nlifecycle-commands"]
          vuc2["uc002\ngeneration-browser"]
          vuc3["uc003\nbranch-comparison"]
          vuc4["uc004\nissue-tracker"]
          vuc5["uc005\nmetrics-dashboard"]
          vuc6["uc006\nspec-browser"]
      end

      subgraph TestSuites["Test Suites"]
          ts1["test-rel01.0\n75 cases"]
          ts2["test-rel02.0\n30 cases"]
      end

      uc1 --> prd1
      uc2 --> prd2
      uc3 --> prd1
      uc3 --> prd3
      uc3 --> prd5
      uc4 --> prd1
      uc4 --> prd3
      uc4 --> prd5
      uc5 --> prd2
      uc5 --> prd3
      uc9 --> prd3

      vuc1 --> prd6
      vuc2 --> prd6
      vuc3 --> prd6
      vuc4 --> prd6
      vuc5 --> prd6
      vuc6 --> prd6

      ts1 --> uc1
      ts1 --> uc2
      ts1 --> uc3
      ts1 --> uc4
      ts1 --> uc5
      ts1 --> uc8
      ts1 --> uc9

      ts2 --> vuc1
      ts2 --> vuc2
      ts2 --> vuc3
      ts2 --> vuc4
      ts2 --> vuc5
      ts2 --> vuc6

coverage_gaps: |
  We identify the following gaps in specification coverage:

  PRDs with no dedicated use case:
  - prd005-metrics-collection is exercised indirectly through uc003 (measure)
    and uc004 (stitch), which record InvocationRecords. A dedicated use case
    would provide more thorough validation.

  Implemented features with no PRD:
  - Scaffold (scaffold.go): Scaffold(), Uninstall(), PrepareTestRepo() — wires
    the orchestrator into consuming repos. Covered by eng03 but has no PRD.
  - Context assembly (context.go): ~30 struct types and buildProjectContext() —
    assembles all docs, specs, source code, and issues into a YAML blob for
    prompt injection. No PRD.
  - History saving (cobbler.go, measure.go, stitch.go): HistoryDir config,
    saveHistory(), saveHistoryStats(), saveHistoryPromptAndLog() — persists
    prompt, log, and stats per invocation. No PRD.
  - Tag/versioning (tag.go): Tag() creates v0.YYYYMMDD.N doc-release tags. No PRD.
  - Docker/image management (docker.go): BuildImage(), ensureImage(), embedded
    Dockerfile. Design decision 4 describes the rationale but no PRD specifies
    the build/ensure behavior.
  - Build utilities (build.go): Build(), Lint(), TestUnit(), TestE2E(),
    TestE2EByUseCase(), TestAll(), Install(), Clean(), ExtractCredentials(). No PRD.
  - Phase-aware logging (orchestrator.go): setPhase/clearPhase, logf with
    [phase +elapsed]. No PRD.

  Use cases without dedicated YAML files (traced in test suites only):
  - rel01.0-uc006-scaffold-operations: traced in test-rel01.0.yaml but has no
    standalone use case YAML file. Test cases serve as the specification.
  - rel01.0-uc007-build-tooling: traced in test-rel01.0.yaml but has no
    standalone use case YAML file. Test cases serve as the specification.

  Stale specifications:
  - prd003 R2.7 says "parse the JSON output file" but Claude writes YAML.
  - Planning constitution P2 says 300-700 lines; config defaults are 250-350.

  Numbering gaps:
  - No prd004 exists. The PRD numbering skips from prd003 to prd005.

references:
  - VISION.yaml
  - ARCHITECTURE.yaml
  - road-map.yaml
